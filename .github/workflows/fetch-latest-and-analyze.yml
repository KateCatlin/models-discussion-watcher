name: Fetch Latest and Analyze

on:
  workflow_dispatch:

permissions:
  models: read
  contents: read

jobs:
  fetch-and-analyze:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install Playwright
        run: |
          npm init -y
          npm install playwright

      - name: Install Playwright browsers
        run: npx playwright install --with-deps

      - name: Fetch discussions
        run: node scripts/fetch-discussions.js

      - name: Analyze discussions with AI
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ -f "discussions.json" ]; then
            echo "=== ANALYZING DISCUSSIONS WITH GPT-4O ==="
            
            # Install jq if not available
            if ! command -v jq &> /dev/null; then
              apt-get update && apt-get install -y jq
            fi
            
            # Read discussions data
            DISCUSSIONS=$(cat discussions.json)
            
            # Check if there are any discussions
            if [ "$(echo "$DISCUSSIONS" | jq 'length')" -eq 0 ]; then
              echo "No discussions found from the last 30 days."
              exit 0
            fi
            
            # Create a simplified discussion list for AI analysis
            DISCUSSION_LIST=$(echo "$DISCUSSIONS" | jq -r '.[] | "Title: \(.title) | Author: \(.author) | Comments: \(.commentCount) | Date: \(.timeText) | URL: \(.url)"')
            
            # Create AI analysis prompt
            cat > analysis_prompt.txt << 'EOF'
          You are an expert at analyzing GitHub discussions to identify potential bug reports and categorize discussions. 

          Please analyze the following GitHub discussions from the Models category and classify each one into one of these categories:
          - BUG_REPORT: Issues, problems, errors, crashes, things not working as expected
          - FEATURE_REQUEST: Requests for new features, enhancements, improvements
          - QUESTION: How-to questions, help requests, clarifications, documentation questions
          - DISCUSSION: General discussions, announcements, sharing experiences

          For each discussion, provide:
          1. Classification (BUG_REPORT, FEATURE_REQUEST, QUESTION, or DISCUSSION)
          2. Confidence score (0-100%)
          3. Brief reasoning (1-2 sentences)

          Format your response as a JSON array with this structure:
          [
            {
              "title": "Discussion title",
              "classification": "BUG_REPORT",
              "confidence": 85,
              "reasoning": "The title mentions 'empty outputs' which suggests a functionality issue or bug."
            }
          ]

          Here are the discussions to analyze:
          EOF
            
            # Add discussions to prompt
            echo "$DISCUSSION_LIST" >> analysis_prompt.txt
            
            # Read the prompt
            PROMPT=$(cat analysis_prompt.txt)
            
            # Call GitHub Models API with GPT-4o
            echo "ğŸ¤– Analyzing discussions with AI..."
            
            # Check if we have a token (simplified)
            if [ -z "$GITHUB_TOKEN" ]; then
              echo "ERROR: GITHUB_TOKEN is not set"
              exit 1
            fi
            
            # Use the correct API endpoint and model format
            AI_RESPONSE=$(curl -s -w "\nHTTP_STATUS:%{http_code}\n" "https://models.github.ai/inference/chat/completions" \
              -H "Accept: application/vnd.github+json" \
              -H "Content-Type: application/json" \
              -H "Authorization: Bearer $GITHUB_TOKEN" \
              -H "X-GitHub-Api-Version: 2022-11-28" \
              -d "{
                \"model\": \"openai/gpt-4o\",
                \"messages\": [
                  {
                    \"role\": \"user\",
                    \"content\": $(echo "$PROMPT" | jq -Rs .)
                  }
                ]
              }")
            
            # Extract HTTP status and response
            HTTP_STATUS=$(echo "$AI_RESPONSE" | grep "HTTP_STATUS:" | cut -d: -f2)
            API_RESPONSE=$(echo "$AI_RESPONSE" | sed '/HTTP_STATUS:/d')
            
            # Check if the request was successful
            if [ "$HTTP_STATUS" != "200" ]; then
              echo "âŒ AI API request failed. Using fallback analysis..."
              
              # Fallback to keyword-based analysis
              AI_ANALYSIS=$(echo "$DISCUSSIONS" | jq -r '[.[] | {
                "title": .title,
                "classification": (if (.title | ascii_downcase | test("bug|error|issue|problem|broken|not working|fail|crash|exception|wrong|incorrect")) then "BUG_REPORT"
                  elif (.title | ascii_downcase | test("feature|request|enhancement|improvement|add|support")) then "FEATURE_REQUEST"  
                  elif (.title | ascii_downcase | test("how to|question|help|documentation|guide|usage")) then "QUESTION"
                  else "DISCUSSION" end),
                "confidence": (if (.title | ascii_downcase | test("bug|error|crash")) then 80
                  elif (.title | ascii_downcase | test("issue|problem|broken")) then 70
                  elif (.title | ascii_downcase | test("feature|request")) then 75
                  elif (.title | ascii_downcase | test("how to|question")) then 65
                  else 50 end),
                "reasoning": "Classified using keyword analysis."
              }]')
            else
              # Extract AI response content and clean it
              AI_ANALYSIS=$(echo "$API_RESPONSE" | jq -r '.choices[0].message.content' | sed 's/```json//g' | sed 's/```//g' | sed '/^$/d')
            fi
            
            echo ""
            echo "========================================"
            echo "ğŸ¤– GITHUB DISCUSSIONS ANALYSIS REPORT"
            echo "========================================"
            echo ""
            
            # Parse AI analysis and create summary
            if echo "$AI_ANALYSIS" | jq -e . >/dev/null 2>&1; then
              
              # Get counts for each category
              BUG_COUNT=$(echo "$AI_ANALYSIS" | jq '[.[] | select(.classification == "BUG_REPORT")] | length')
              FEATURE_COUNT=$(echo "$AI_ANALYSIS" | jq '[.[] | select(.classification == "FEATURE_REQUEST")] | length')
              QUESTION_COUNT=$(echo "$AI_ANALYSIS" | jq '[.[] | select(.classification == "QUESTION")] | length')
              DISCUSSION_COUNT=$(echo "$AI_ANALYSIS" | jq '[.[] | select(.classification == "DISCUSSION")] | length')
              TOTAL_COUNT=$(echo "$AI_ANALYSIS" | jq 'length')
              
              echo "ï¿½ SUMMARY (Last 30 Days)"
              echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
              echo "ï¿½ğŸ› Bug Reports: $BUG_COUNT"
              echo "âœ¨ Feature Requests: $FEATURE_COUNT"
              echo "â“ Questions: $QUESTION_COUNT"
              echo "ğŸ’¬ General Discussions: $DISCUSSION_COUNT"
              echo "ğŸ“ Total Discussions: $TOTAL_COUNT"
              echo ""
              
              # Show bug reports section
              echo "ğŸ› BUG REPORTS DETECTED"
              echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
              if [ "$BUG_COUNT" -gt 0 ]; then
                # Get bug report titles and add URLs from original discussions
                echo "$AI_ANALYSIS" | jq -r '.[] | select(.classification == "BUG_REPORT") | .title' | while read -r title; do
                  confidence=$(echo "$AI_ANALYSIS" | jq -r --arg title "$title" '.[] | select(.title == $title) | .confidence')
                  reasoning=$(echo "$AI_ANALYSIS" | jq -r --arg title "$title" '.[] | select(.title == $title) | .reasoning')
                  url=$(echo "$DISCUSSIONS" | jq -r --arg title "$title" '.[] | select(.title == $title) | .url')
                  
                  echo "â€¢ $title ($confidence% confidence)"
                  echo "  ğŸ’­ $reasoning"
                  echo "  ğŸ”— $url"
                  echo ""
                done
              else
                echo "âœ… No bug reports identified in recent discussions."
                echo ""
              fi
              
              # Show all other discussions organized
              echo "ğŸ“‹ OTHER RECENT DISCUSSIONS"
              echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
              
              # Feature Requests
              if [ "$FEATURE_COUNT" -gt 0 ]; then
                echo "âœ¨ Feature Requests:"
                echo "$AI_ANALYSIS" | jq -r '.[] | select(.classification == "FEATURE_REQUEST") | .title' | while read -r title; do
                  confidence=$(echo "$AI_ANALYSIS" | jq -r --arg title "$title" '.[] | select(.title == $title) | .confidence')
                  url=$(echo "$DISCUSSIONS" | jq -r --arg title "$title" '.[] | select(.title == $title) | .url')
                  echo "  â€¢ $title ($confidence% confidence)"
                  echo "    ğŸ”— $url"
                done
                echo ""
              fi
              
              # Questions
              if [ "$QUESTION_COUNT" -gt 0 ]; then
                echo "â“ Questions:"
                echo "$AI_ANALYSIS" | jq -r '.[] | select(.classification == "QUESTION") | .title' | while read -r title; do
                  confidence=$(echo "$AI_ANALYSIS" | jq -r --arg title "$title" '.[] | select(.title == $title) | .confidence')
                  url=$(echo "$DISCUSSIONS" | jq -r --arg title "$title" '.[] | select(.title == $title) | .url')
                  echo "  â€¢ $title ($confidence% confidence)"
                  echo "    ğŸ”— $url"
                done
                echo ""
              fi
              
              # General Discussions
              if [ "$DISCUSSION_COUNT" -gt 0 ]; then
                echo "ğŸ’¬ General Discussions:"
                echo "$AI_ANALYSIS" | jq -r '.[] | select(.classification == "DISCUSSION") | .title' | while read -r title; do
                  confidence=$(echo "$AI_ANALYSIS" | jq -r --arg title "$title" '.[] | select(.title == $title) | .confidence')
                  url=$(echo "$DISCUSSIONS" | jq -r --arg title "$title" '.[] | select(.title == $title) | .url')
                  echo "  â€¢ $title ($confidence% confidence)"
                  echo "    ğŸ”— $url"
                done
                echo ""
              fi
              
              # Show most recent discussion details
              echo "ğŸ” MOST RECENT DISCUSSION"
              echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
              LATEST_TITLE=$(echo "$DISCUSSIONS" | jq -r '.[0].title')
              LATEST_AUTHOR=$(echo "$DISCUSSIONS" | jq -r '.[0].author')
              LATEST_TIME=$(echo "$DISCUSSIONS" | jq -r '.[0].timeText')
              LATEST_COMMENTS=$(echo "$DISCUSSIONS" | jq -r '.[0].commentCount')
              LATEST_URL=$(echo "$DISCUSSIONS" | jq -r '.[0].url')
              
              echo "ğŸ“ Title: $LATEST_TITLE"
              echo "ğŸ‘¤ Author: $LATEST_AUTHOR"
              echo "ğŸ“… Time: $LATEST_TIME"
              echo "ğŸ’¬ Comments: $LATEST_COMMENTS"
              echo "ğŸ”— URL: $LATEST_URL"
              echo ""
              
              # Show AI analysis of the latest discussion
              echo "$AI_ANALYSIS" | jq -r --arg title "$LATEST_TITLE" '.[] | select(.title == $title) | "ğŸ¤– AI Classification: \(.classification)\nğŸ¯ Confidence: \(.confidence)%\nğŸ’­ Reasoning: \(.reasoning)"'
              
            else
              echo "âŒ Could not parse AI analysis. Raw response:"
              echo "$AI_ANALYSIS"
            fi
            
            echo ""
            echo "========================================"
            
            # Clean up
            rm -f analysis_prompt.txt
            
          else
            echo "No discussions.json file found. Skipping analysis."
          fi
